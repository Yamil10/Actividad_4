<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Bienvenido al Gestor de Videojuegos</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 600px; margin: 2rem auto; background:#f5f5f5; color:#333; }
        h1, h2 { text-align:center; color:#444; }
        nav { text-align:center; margin-bottom:1rem; }
        .tab { display: inline-block; margin:0 .5rem; padding:.5rem 1rem; cursor: pointer; color:#fff; background:#007bff; border-radius:4px; }
        .tab:hover { background:#0056b3; }
        .tab.active { background:#0056b3; }
        .form-container { display: none; background:#fff; padding:20px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,.1); }
        .form-container.active { display: block; }
        form label { display:block; margin:10px 0 5px; }
        form input { width:100%; padding:8px; box-sizing:border-box; }
        form button { margin-top:15px; padding:10px 20px; background:#28a745; color:#fff; border:none; border-radius:4px; cursor:pointer; }
        form button:hover { background:#218838; }
        table { width:100%; border-collapse:collapse; margin-top:10px; }
        table th, table td { padding:8px; border:1px solid #ddd; text-align:left; }
        table th { background:#f0f0f0; }
        #message { font-weight:bold; }
    </style>
</head>
<body>
    <h1>Gestor de Videojuegos</h1>
    <nav>
        <span class="tab" data-target="login">Iniciar sesión</span>
        <span class="tab" data-target="register">Registrarse</span>
    </nav>

    <div id="message" style="color: red; margin: 1rem 0; text-align:center;"></div>

    <div id="login" class="form-container active">
        <h2>Login</h2>
        <form id="loginForm">
            <label>Email:<br><input name="email" type="email" required></label><br>
            <label>Contraseña:<br><input name="password" type="password" required></label><br>
            <button type="submit">Entrar</button>
        </form>
    </div>

    <div id="register" class="form-container">
        <h2>Registro</h2>
        <form id="registerForm">
            <label>Email:<br><input name="email" type="email" required></label><br>
            <label>Contraseña:<br><input name="password" type="password" required></label><br>
            <button type="submit">Registrar</button>
        </form>
    </div>

    <div id="games" class="form-container">
        <h2>Gestionar Juegos</h2>
        <button id="loadGames">Cargar juegos</button>
        <table id="gamesTable" border="1" style="width:100%;margin-top:1rem;">
            <thead><tr><th>Título</th><th>Género</th><th>Plataforma</th><th>Precio</th><th>Acciones</th></tr></thead>
            <tbody></tbody>
        </table>
        <h3>Agregar/editar</h3>
        <form id="gameForm">
            <input type="hidden" name="id" />
            <label>Título:<br><input name="titulo" required></label><br>
            <label>Género:<br><input name="genero" required></label><br>
            <label>Plataforma:<br><input name="plataforma" required></label><br>
            <label>Precio:<br><input name="precio" required></label><br>
            <button type="submit">Guardar</button>
        </form>
    </div>

    <script>
        const showMessage = (msg, success = false) => {
            const el = document.getElementById('message');
            el.style.color = success ? 'green' : 'red';
            el.textContent = msg;
            setTimeout(() => el.textContent = '', 3000);
        };

        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.form-container').forEach(f => f.classList.remove('active'));
                document.getElementById(tab.dataset.target).classList.add('active');
                showMessage('');
            });
        });

        let authToken = null;
        document.getElementById('loginForm').addEventListener('submit', async e => {
            e.preventDefault();
            const data = Object.fromEntries(new FormData(e.target));
            const res = await fetch('/api/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const json = await res.json();
            if (res.ok) {
                authToken = json.token;
                showMessage('Login correcto', true);
                document.querySelectorAll('.form-container').forEach(f => f.classList.remove('active'));
                document.getElementById('games').classList.add('active');
            } else {
                showMessage(json.msg || 'Error al iniciar sesión');
            }
        });

        const reloadGames = async () => {
            if (!authToken) return;
            const res = await fetch('/api/games', { headers:{ Authorization: 'Bearer '+authToken } });
            const arr = await res.json();
            const tbody = document.querySelector('#gamesTable tbody');
            tbody.innerHTML = '';
            arr.forEach(g => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${g.titulo}</td><td>${g.genero}</td><td>${g.plataforma}</td><td>${g.precio}</td><td>` +
                    `<button data-id="${g.id}" class="edit">E</button> ` +
                    `<button data-id="${g.id}" class="del">X</button></td>`;
                tbody.appendChild(tr);
            });
        };

        document.getElementById('loadGames').addEventListener('click', reloadGames);

        document.querySelector('#gamesTable tbody').addEventListener('click', async e => {
            if (e.target.classList.contains('edit')) {
                const id = e.target.dataset.id;
                const res = await fetch('/api/games/'+id, { headers:{ Authorization:'Bearer '+authToken }});
                const game = await res.json();
                const form = document.getElementById('gameForm');
                form.id.value = game.id;
                form.titulo.value = game.titulo;
                form.genero.value = game.genero;
                form.plataforma.value = game.plataforma;
                form.precio.value = game.precio;
            }
            if (e.target.classList.contains('del')) {
                const id = e.target.dataset.id;
                await fetch('/api/games/'+id, { method:'DELETE', headers:{ Authorization:'Bearer '+authToken }});
                reloadGames();
            }
        });

        document.getElementById('gameForm').addEventListener('submit', async e => {
            e.preventDefault();
            const data = Object.fromEntries(new FormData(e.target));
            const id = data.id;
            delete data.id;
            const url = '/api/games' + (id ? '/'+id : '');
            const method = id ? 'PUT' : 'POST';
            const res = await fetch(url, { method, headers:{ 'Content-Type':'application/json', Authorization:'Bearer '+authToken }, body: JSON.stringify(data) });
            if (res.ok) {
                showMessage(id ? 'Juego actualizado' : 'Juego creado', true);
                e.target.reset();
                reloadGames();
            } else {
                showMessage('Error al guardar');
            }
        });

        document.getElementById('registerForm').addEventListener('submit', async e => {
            e.preventDefault();
            const data = Object.fromEntries(new FormData(e.target));
            const res = await fetch('/api/auth/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const json = await res.json();
            if (res.ok) {
                showMessage('Registrado con éxito, token: ' + json.token, true);
            } else {
                showMessage(json.msg || 'Error en registro');
            }
        });
    </script>
</body>
</html>